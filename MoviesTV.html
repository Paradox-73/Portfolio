<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movies and shows</title>
    <link rel="icon" type="image/x-icon" href="Images/profile.jpg">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- LOAD CONFIGURATION (Make sure config.js exists locally) -->
    <script src="config.js"></script>

    <style>
        :root {
            --primary-black: #141414;
            --netflix-red: #E50914;
            --white: #fff;
            --grey-text: #b3b3b3;
            --placeholder-grey: #2f2f2f;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background-color: var(--primary-black);
            color: var(--white);
            font-family: 'Inter', Helvetica, Arial, sans-serif;
            overflow-x: hidden;
        }

        /* --- Utils --- */
        .hidden { display: none !important; }
        .no-scroll { overflow: hidden; }

        /* --- Header --- */
        header {
            position: fixed; top: 0; width: 100%; z-index: 1000;
            transition: background-color 0.4s ease;
            background: linear-gradient(to bottom, rgba(0,0,0,0.7) 10%, rgba(0,0,0,0));
        }
        header.scrolled { background-color: rgb(20, 20, 20); }

        .header-container {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 4%; height: 68px;
        }

        .left-nav, .right-nav { display: flex; align-items: center; gap: 20px; }
        
        .logo img { height: 35px; vertical-align: middle; }

        .nav-links { list-style: none; display: flex; gap: 20px; }
        .nav-links li a { text-decoration: none; color: #e5e5e5; font-size: 0.9rem; transition: color 0.3s; cursor: pointer; }
        .nav-links li a:hover, .nav-links li a.active { color: var(--white); font-weight: 500; }
        @media (max-width: 900px) { .nav-links { display: none; } }

        .icon-btn { cursor: pointer; color: white; display: flex; align-items: center; }
        .avatar { width: 32px; height: 32px; border-radius: 4px; overflow: hidden; }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
        .caret { border: 5px solid transparent; border-top-color: #fff; margin-left: 5px; margin-top: 5px; }

        /* --- Billboard --- */
        .billboard {
            position: relative; height: 56.25vw; /* 16:9 Aspect Ratio */
            max-height: 85vh; min-height: 400px;
            width: 100%; background: #141414; overflow: hidden;
            transition: opacity 0.5s ease;
        }
        
        .billboard-video {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; transform: scale(1.35); 
            transform-origin: center center;
        }
        
        .billboard-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to top, #141414 10%, transparent 50%);
            z-index: 2;
        }

        .billboard-info {
            position: absolute; top: 30%; left: 4%; width: 40%; z-index: 10;
            display: flex; flex-direction: column; justify-content: center;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .billboard-title {
            font-size: clamp(2rem, 4vw, 4.5rem); 
            font-weight: 800; line-height: 1.1; margin-bottom: 1rem;
            text-transform: uppercase;
            opacity: 0; animation: fadeInUp 0.8s forwards 0.2s;
        }
        
        .billboard-desc {
            font-size: clamp(0.9rem, 1.2vw, 1.4rem); 
            margin-bottom: 1.5rem; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;
            opacity: 0; animation: fadeInUp 0.8s forwards 0.4s;
        }
        
        .billboard-actions {
            opacity: 0; animation: fadeInUp 0.8s forwards 0.6s;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .btn {
            border: none; padding: 0.6rem 2rem; border-radius: 4px;
            font-size: 1.1rem; font-weight: bold; cursor: pointer;
            display: inline-flex; align-items: center; gap: 0.8rem; margin-right: 1rem;
            transition: transform 0.2s;
        }
        .btn:hover { transform: scale(1.05); }
        .btn-white { background: white; color: black; }
        .btn-grey { background: rgba(109, 109, 110, 0.7); color: white; }

        .mute-btn {
            position: absolute; right: 4%; bottom: 40%;
            border: 1px solid rgba(255,255,255,0.5); background: rgba(0,0,0,0.3);
            color: white; padding: 10px; border-radius: 50%; cursor: pointer; z-index: 20;
        }
        .mute-btn:hover { background: white; color: black; }

        /* --- Main Layouts --- */
        .main-content { position: relative; z-index: 20; padding-bottom: 10px; margin-top: -50px; }
        
        .row-container { margin-bottom: 3vw; padding: 0 4%; }
        .row-header { font-size: 1.4rem; font-weight: 600; color: #e5e5e5; margin-bottom: 0.5rem; cursor: pointer; }
        .row-header:hover { color: white; }
        .row-content { position: relative; }
        
        .slider-track {
            display: flex; gap: 8px; overflow-x: auto; scroll-behavior: smooth;
            padding: 40px 0; margin: -40px 0; 
        }
        .slider-track::-webkit-scrollbar { display: none; }

        /* Grid View */
        .grid-view-container { padding: 120px 4% 50px; min-height: 100vh; }
        .grid-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .grid-title { font-size: 2.5rem; font-weight: bold; }
        .genre-select {
            background: black; color: white; border: 1px solid white;
            padding: 5px 15px; font-size: 1rem; cursor: pointer;
        }
        .media-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 50px 15px; 
        }

        /* --- Cards --- */
        .movie-box, .grid-card {
            background: var(--placeholder-grey); border-radius: 4px;
            cursor: pointer; transition: transform 0.3s ease, z-index 0s;
            position: relative; z-index: 1; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }
        .movie-box { flex: 0 0 auto; width: 240px; height: 135px; }
        .grid-card { width: 100%; aspect-ratio: 16/9; }

        .movie-box img, .grid-card img { 
            width: 100%; height: 100%; object-fit: cover; border-radius: 4px; 
            opacity: 0; transition: opacity 0.5s; 
        }
        .movie-box img.loaded, .grid-card img.loaded { opacity: 1; }

        .movie-box:hover, .grid-card:hover {
            transform: scale(1.4); z-index: 100; box-shadow: 0 0 20px rgba(0,0,0,0.7);
        }
        
        .hover-details {
            position: absolute; bottom: 0; left: 0; right: 0;
            padding: 20px 10px 10px;
            background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, transparent 100%);
            font-size: 0.85rem; font-weight: 500; text-align: center;
            opacity: 0; transition: opacity 0.3s;
            pointer-events: none;
        }
        .movie-box:hover .hover-details, .grid-card:hover .hover-details { opacity: 1; }

        .placeholder-title {
            position: absolute; color: #777; font-size: 0.9rem; 
            text-align: center; padding: 10px; font-weight: bold; width: 100%;
            top: 50%; transform: translateY(-50%);
        }
        img.loaded + .placeholder-title { display: none; }

        .slider-handle {
            position: absolute; top: 0; bottom: 0; width: 4%;
            background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
            font-size: 3rem; color: white; opacity: 0; z-index: 10; cursor: pointer; height: 135px;
        }
        .row-container:hover .slider-handle { opacity: 1; }
        .left-handle { left: -4%; }
        .right-handle { right: -4%; }

        /* --- Overlays --- */
        .search-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 2000;
            display: flex; justify-content: center; align-items: flex-start;
            padding-top: 100px; display: none;
        }
        .search-overlay.active { display: flex; }
        .search-container { 
            width: 80%; max-width: 1000px; background: #141414; 
            padding: 30px; border-radius: 8px; border: 1px solid #333;
            max-height: 80vh; overflow-y: auto; position: relative;
        }
        .search-header { display: flex; width: 100%; margin-bottom: 20px; position: relative; }
        .search-bar-large {
            width: 100%; background: transparent; border: none; border-bottom: 2px solid #555;
            padding: 15px 0; color: white; font-size: 2rem; outline: none;
        }
        .search-close { 
            position: absolute; top: -50px; right: 0; font-size: 3rem; color: #888; cursor: pointer; 
        }
        .search-close:hover { color: white; }
        .search-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; }
        .search-card { position: relative; cursor: pointer; transition: transform 0.2s; }
        .search-card:hover { transform: scale(1.05); z-index: 5; }
        .search-card img { width: 100%; aspect-ratio: 16/9; object-fit: cover; border-radius: 4px; }
        .search-card-title { font-size: 0.9rem; color: #ccc; margin-top: 5px; }

        .dialog-overlay, .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 4000;
            display: flex; justify-content: center; align-items: center; display: none;
        }
        .modal-overlay { align-items: flex-start; padding-top: 30px; overflow-y: auto; z-index: 5000; }
        
        .dialog-box {
            background: #181818; padding: 40px; border-radius: 8px; width: 400px; 
            text-align: center; border: 1px solid #333; box-shadow: 0 0 30px rgba(0,0,0,0.8);
        }
        .dialog-input { width: 100%; padding: 12px; margin: 20px 0; background: #333; border: 1px solid #555; color: white; }

        .modal-content {
            background: #181818; width: 900px; max-width: 95%;
            border-radius: 10px; overflow: hidden; position: relative; margin-bottom: 50px;
            box-shadow: 0 0 50px rgba(0,0,0,0.9);
        }
        .modal-hero { height: 500px; position: relative; background: black; }
        .modal-hero iframe { width: 100%; height: 100%; border: none; }
        .modal-hero img { width: 100%; height: 100%; object-fit: cover; }
        .modal-close-btn {
            position: absolute; top: 15px; right: 15px; width: 35px; height: 35px; border-radius: 50%;
            background: #181818; color: white; display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 20; font-size: 1.2rem;
        }
        .modal-body { padding: 40px; }
        .modal-meta { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; font-weight: 500; }
        .match-text { color: #46d369; }
        .modal-cols { display: grid; grid-template-columns: 2.5fr 1fr; gap: 30px; }
        .modal-desc { line-height: 1.5; font-size: 1.1rem; color: #eee; }
        .modal-tags { font-size: 0.9rem; color: #aaa; }
        .modal-tags span { color: #ddd; }
        
        .tabs-container { margin-top: 30px; border-top: 1px solid #333; padding-top: 15px; display: flex; align-items: center; gap: 20px; }
        .tab-btn { background: transparent; border: none; color: #888; font-size: 1.2rem; font-weight: bold; cursor: pointer; padding-bottom: 5px; }
        .tab-btn.active { color: white; border-bottom: 3px solid #E50914; }
        .season-select { background: #222; color: white; border: 1px solid #555; padding: 5px 10px; border-radius: 4px; margin-left: auto; }
        
        .more-like-this-grid, .episodes-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px; }
        .mlt-card, .episode-card { background: #2f2f2f; border-radius: 4px; overflow: hidden; cursor: pointer; }
        .mlt-card img { width: 100%; aspect-ratio: 16/9; object-fit: cover; }
        .episode-card { padding-bottom: 10px; }
        .episode-img { width: 100%; aspect-ratio: 16/9; object-fit: cover; }
        .episode-info { padding: 10px; }
        .episode-title { font-weight: bold; font-size: 0.9rem; display: flex; justify-content: space-between; margin-bottom: 5px;}
        .episode-desc { font-size: 0.8rem; color: #aaa; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }

        .check-seen-btn { 
            background: transparent; border: 2px solid #555; color: white; padding: 10px; border-radius: 4px; cursor: pointer; margin-top: 20px; display: flex; align-items: center; gap: 10px; width: fit-content;
        }
        .check-seen-btn:hover { border-color: white; }

        /* Footer */
        footer { max-width: 980px; margin: 0 auto; padding: 30px 4%; color: grey; margin-top: 0px; border-top: 1px solid #333; }
        .social-links { display: flex; gap: 25px; margin-bottom: 20px; }
        .social-links a { color: white; opacity: 0.7; transition: opacity 0.3s; }
        .social-links a:hover { opacity: 1; }
        .social-links svg { width: 24px; height: 24px; fill: currentColor; }
        .footer-links { display: grid; grid-template-columns: repeat(4, 1fr); font-size: 13px; gap: 15px; }
        .footer-links ul { list-style: none; }
        .footer-links li { margin-bottom: 10px; }
        .footer-links a { color: grey; text-decoration: none; }
        .footer-links a:hover { text-decoration: underline; }

        /* Profile & Z-Index overrides */
        .profile-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #141414; z-index: 9000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .profile-row { display: flex; gap: 30px; margin-top: 30px; }
        .profile-card { text-align: center; cursor: pointer; opacity: 0.8; transition: opacity 0.2s; }
        .profile-card:hover { opacity: 1; }
        .profile-img { width: 150px; height: 150px; background-size: cover; border-radius: 4px; margin-bottom: 15px; border: 3px solid transparent; }
        .profile-card:hover .profile-img { border-color: white; }
        #passwordDialog { z-index: 6000; }
    </style>
</head>
<body>

    <!-- Profile Screen -->
    <div class="profile-layer" id="profileLayer">
        <h1 style="font-weight: 400; font-size: 3rem;">Who's watching?</h1>
        <div class="profile-row">
            <div class="profile-card" onclick="startApp()">
                <div class="profile-img" style="background-image: url('Images/profile.jpg')"></div>
                <h3>Kanav</h3>
            </div>
            <div class="profile-card" onclick="startApp()">
                <div class="profile-img" style="background-image: url('https://mir-s3-cdn-cf.behance.net/project_modules/disp/84c20033850498.56ba69ac290ea.png')"></div>
                <h3>Guest</h3>
            </div>
        </div>
        <div style="margin-top: 50px; border: 1px solid grey; padding: 10px 30px; cursor: pointer;">MANAGE PROFILES</div>
    </div>

    <!-- Search Overlay -->
    <div class="search-overlay" id="searchOverlay">
        <div class="search-container">
            <div class="search-close" onclick="closeSearch()">✕</div>
            <div class="search-header">
                <input type="text" class="search-bar-large" id="fullSearchBar" placeholder="Search movies, TV, anime..." onkeyup="handleSearchKey(event)">
            </div>
            <div class="search-grid" id="searchGrid"></div>
        </div>
    </div>

    <!-- Recommendation Dialog -->
    <div class="dialog-overlay" id="recDialog">
        <div class="dialog-box">
            <h3>Recommend to Kanav?</h3>
            <p>Kanav hasn't seen this yet.</p>
            <input type="text" id="recNameInput" class="dialog-input" placeholder="Your Name">
            <div style="display:flex; gap:10px; justify-content:center;">
                <button class="btn btn-grey" onclick="closeRecDialog()">Cancel</button>
                <button class="btn btn-white" onclick="confirmRecommendation()">Recommend</button>
            </div>
        </div>
    </div>

    <!-- Admin Password Dialog -->
    <div class="dialog-overlay" id="passwordDialog">
        <div class="dialog-box">
            <h3>Admin Verification</h3>
            <p>Enter password to confirm you've seen this.</p>
            <input type="password" id="adminPwdInput" class="dialog-input" placeholder="Password">
            <div style="display:flex; gap:10px; justify-content:center;">
                <button class="btn btn-grey" onclick="closePasswordDialog()">Cancel</button>
                <button class="btn btn-white" onclick="submitAdminPassword()">Verify</button>
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div class="modal-overlay" id="detailModal">
        <div class="modal-content">
            <div class="modal-close-btn" onclick="closeModal()">✕</div>
            <div class="modal-hero">
                <iframe id="modalFrame" src="" allow="autoplay; encrypted-media" allowfullscreen></iframe>
                <img id="modalPoster" src="" class="hidden">
            </div>
            <div class="modal-body">
                <h1 id="mTitle">Title</h1>
                <div class="modal-meta">
                    <span id="mMatch" class="match-text">98% Match</span>
                    <span id="mYear">2023</span>
                    <span style="border:1px solid #777; padding:0 5px;">HD</span>
                    <span id="mEpisodesCount" style="color: #aaa; margin-left: 10px;"></span>
                </div>
                <div class="modal-cols">
                    <div>
                        <p id="mDesc" class="modal-desc">Description here...</p>
                        <div id="checkOffSection" class="hidden">
                            <button class="check-seen-btn" onclick="checkOffItem()">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                I've Seen This (Admin)
                            </button>
                            <p style="font-size: 12px; color: #777; margin-top: 5px;">Recommender: <span id="mRecommenderName"></span></p>
                        </div>
                    </div>
                    <div class="modal-tags">
                        <p><span>Cast:</span> <span id="mCast"></span></p>
                        <p style="margin-top:10px;"><span>Genres:</span> <span id="mGenres"></span></p>
                    </div>
                </div>
                <div class="tabs-container">
                    <button class="tab-btn active" id="tabMLT" onclick="switchTab('MLT')">More Like This</button>
                    <button class="tab-btn" id="tabEpisodes" onclick="switchTab('EPISODES')">Episodes</button>
                    <select id="seasonSelect" class="season-select hidden" onchange="fetchSeason(this.value)"></select>
                </div>
                <div id="mltGrid" class="more-like-this-grid"></div>
                <div id="episodesGrid" class="episodes-grid hidden"></div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app" class="hidden">
        <header id="mainHeader">
            <div class="header-container">
                <div class="left-nav">
                    <a href="javascript:showHome()" class="logo">
                        <img src="images/MATV.png" alt="MATV">
                    </a>
                    <ul class="nav-links">
                        <li><a onclick="showGrid('movies')">Movies</a></li>
                        <li><a onclick="showGrid('shows')">Shows</a></li>
                        <li><a onclick="showGrid('anime')">Anime</a></li>
                    </ul>
                </div>
                <div class="right-nav">
                    <div class="icon-btn" onclick="openSearch()">
                        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    </div>
                    <div class="icon-btn">Children</div>
                    <div class="icon-btn">
                        <div class="avatar"><img src="https://upload.wikimedia.org/wikipedia/commons/0/0b/Netflix-avatar.png"></div>
                        <div class="caret"></div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Home View (Billboard + Carousel) -->
        <div id="homeView">
            <div class="billboard" id="billboard">
                <!-- Video Background with JS API enabled -->
                <div class="billboard-video">
                    <div id="ytPlayer"></div> <!-- YouTube Iframe API targets this div -->
                </div>
                <div class="billboard-layer"></div>
                
                <div class="billboard-info">
                    <h1 class="billboard-title" id="bbTitle">Spider-Man: Across the Spider-Verse</h1>
                    <p class="billboard-desc" id="bbDesc">Miles Morales catapults across the Multiverse, where he encounters a team of Spider-People charged with protecting its very existence.</p>
                    <div class="billboard-actions">
                        <button class="btn btn-white" id="bbPlayBtn"><svg width="24" height="24" fill="currentColor" style="margin-right:5px"><path d="M6 4l15 8-15 8z"/></svg> Play</button>
                        <button class="btn btn-grey" id="bbInfoBtn"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:5px"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg> More Info</button>
                    </div>
                </div>
                
                <div class="mute-btn" onclick="toggleMute()">
                    <svg id="muteIcon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 5L6 9H2V15H6L11 19V5z"></path><path d="M23 9L17 15"></path><path d="M17 9L23 15"></path></svg>
                </div>
            </div>

            <div class="main-content">
                <div class="row-container" id="recRow" style="display:none">
                    <h2 class="row-header">Recommended for Kanav</h2>
                    <div class="row-content">
                        <div class="slider-handle left-handle" onclick="scrollRow('recTrack', -1)">&#8249;</div>
                        <div class="slider-track" id="recTrack"></div>
                        <div class="slider-handle right-handle" onclick="scrollRow('recTrack', 1)">&#8250;</div>
                    </div>
                </div>
                
                <div class="row-container">
                    <h2 class="row-header">Movies</h2>
                    <div class="row-content">
                        <div class="slider-handle left-handle" onclick="scrollRow('moviesTrack', -1)">&#8249;</div>
                        <div class="slider-track" id="moviesTrack"></div>
                        <div class="slider-handle right-handle" onclick="scrollRow('moviesTrack', 1)">&#8250;</div>
                    </div>
                </div>

                <div class="row-container">
                    <h2 class="row-header">Shows</h2>
                    <div class="row-content">
                        <div class="slider-handle left-handle" onclick="scrollRow('showsTrack', -1)">&#8249;</div>
                        <div class="slider-track" id="showsTrack"></div>
                        <div class="slider-handle right-handle" onclick="scrollRow('showsTrack', 1)">&#8250;</div>
                    </div>
                </div>

                <div class="row-container">
                    <h2 class="row-header">Anime</h2>
                    <div class="row-content">
                        <div class="slider-handle left-handle" onclick="scrollRow('animeTrack', -1)">&#8249;</div>
                        <div class="slider-track" id="animeTrack"></div>
                        <div class="slider-handle right-handle" onclick="scrollRow('animeTrack', 1)">&#8250;</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Grid View (Movies/Shows/Anime) -->
        <div id="gridView" class="grid-view-container hidden">
            <div class="grid-header">
                <h2 class="grid-title"><span id="gridPageTitle">Movies</span> <span id="gridCount" style="font-size:1.2rem; color:#777; margin-left:10px;">(0)</span></h2>
                <div style="display:flex; align-items:center; gap:15px;">
                    <select id="genreFilter" class="genre-select" onchange="applyGridFilter()">
                        <option value="all">All Genres</option>
                    </select>
                </div>
            </div>
            <div class="media-grid" id="mediaGrid"></div>
        </div>

        <footer>
            <div class="social-links">
                <!-- Social SVGs -->
                <a href="https://www.instagram.com/kanavbhardwaj_73/" target="_blank" title="Instagram"><svg viewBox="0 0 24 24"><rect x="2" y="2" width="20" height="20" rx="5" ry="5" fill="none" stroke="currentColor" stroke-width="2"></rect><circle cx="12" cy="12" r="4" fill="none" stroke="currentColor" stroke-width="2"></circle><circle cx="18" cy="6" r="1" fill="currentColor"></circle></svg></a>
                <a href="https://github.com/Paradox-73" target="_blank" title="GitHub"><svg viewBox="0 0 24 24"><path d="M12 0C5.37 0 0 5.37 0 12c0 5.3 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 21.79 24 17.3 24 12c0-6.63-5.373-12-12-12z" fill="currentColor"/></svg></a>
                <a href="https://www.linkedin.com/in/kanav-bhardwaj-a25940281/" target="_blank" title="LinkedIn"><svg viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z" fill="currentColor"/></svg></a>
                <!-- Letterboxd (3 dots as placeholder icon) -->
                <a href="https://boxd.it/9jB1l" target="_blank" title="Letterboxd"><svg viewBox="0 0 24 24"><circle cx="5" cy="12" r="3" fill="currentColor"/><circle cx="12" cy="12" r="3" fill="currentColor"/><circle cx="19" cy="12" r="3" fill="currentColor"/></svg></a>
                <a href="#" title="Resume"><svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z" fill="currentColor"/></svg></a>
            </div>
            
            <div class="footer-links">
                <ul>
                    <li><a href="../index.html">Home</a></li>
                    <li><a href="../Music.html">Music</a></li>
                    <li><a href="../MoviesTV.html">Movies</a></li>
                </ul>
                <ul>
                    <li><a href="../Games.html">Games</a></li>
                    <li><a href="../Literature.html">Literature</a></li>
                    <li><a href="../art.html">Art</a></li>
                </ul>
                <ul>
                    <li><a href="../sport.html">Sports</a></li>
                    <li><a href="../Projects.html">Projects</a></li>
                    <li><a href="../Food.html">Food</a></li>
                </ul>
                <ul>
                    <li><a href="../Travel.html">Travel</a></li>
                    <li><a href="#">Contact Us</a></li>
                    <li><a href="#">Privacy</a></li>
                </ul>
            </div>
            
            <div style="font-size: 11px; margin-top: 20px;">&copy; 1997-2025 Netflix, Inc.</div>
        </footer>
    </div>

    <!-- Scripts -->
    <!-- 1. Load YouTube IFrame API -->
    <script src="https://www.youtube.com/iframe_api"></script>

    <!-- 2. Application Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Declare currentUser globally at the top level
        let currentUser = null;

        // --- CONFIGURATION LOADING ---
        const localConfig = (typeof CONFIG !== 'undefined') ? CONFIG : { FIREBASE: {}, TMDB_KEY: '', ADMIN_PWD: '' };

        // Prefer config.js if available, else fall back to env var
        const firebaseConfig = (localConfig.FIREBASE && localConfig.FIREBASE.apiKey) 
                               ? localConfig.FIREBASE 
                               : ((typeof __firebase_config !== 'undefined') ? JSON.parse(__firebase_config) : {});
        
        let app, auth, db;
        if (firebaseConfig.apiKey) {
            try { 
                app = initializeApp(firebaseConfig); 
                auth = getAuth(app); 
                db = getFirestore(app); 
                console.log("Firebase Initialized.");
            } 
            catch(e) { console.error("Firebase Init Failed:", e); }
        }
        
        const appId = (typeof __app_id !== 'undefined') ? __app_id : 'default';

        let seenList = new Set(); 
        let seenTitles = new Set(); 
        let pendingRecommendation = null;
        let currentOpenItem = null;
        let currentRecIds = new Set(); 

        // Data Stores 
        let allMovies = []; 
        let allShows = [];
        let allAnime = [];
        let currentGridItems = []; 
        let posterQueue = []; 
        let isFetchingPoster = false;

        const API_KEY = localConfig.TMDB_KEY || ''; // From config.js
        const BASE_URL = 'https://api.themoviedb.org/3';
        const IMG_URL = 'https://image.tmdb.org/t/p/w500';

        // --- Billboard Playlist Manager ---
        const billboardQueue = [
            { id: 569094, type: 'movie' }, // Spider-Man
            { id: 61550, type: 'tv' },     // Daredevil
            { id: 132532, type: 'tv' },    // Dandadan
            { id: 22538, type: 'movie' },  // Scott Pilgrim
            { id: 27205, type: 'movie' }   // Inception
        ];
        let billboardIndex = 0;
        let ytPlayer = null;
        let billboardTimeout = null;

        // Global callback for YouTube API
        window.onYouTubeIframeAPIReady = () => {
            console.log("YouTube API Ready");
            loadBillboardItem(0); 
        };

        async function loadBillboardItem(index) {
            if(!API_KEY) return; // Guard against missing key
            billboardIndex = index;
            const item = billboardQueue[index];
            
            try {
                const res = await fetch(`${BASE_URL}/${item.type}/${item.id}?api_key=${API_KEY}&append_to_response=videos`);
                const data = await res.json();
                
                document.getElementById('bbTitle').innerText = data.title || data.name;
                document.getElementById('bbDesc').innerText = data.overview;
                document.getElementById('bbPlayBtn').onclick = () => openDetails(data, false);
                document.getElementById('bbInfoBtn').onclick = () => openDetails(data, false);

                const trailer = data.videos?.results?.find(v => v.site==='YouTube' && v.type==='Trailer');
                if(trailer) {
                    if(ytPlayer) {
                        ytPlayer.loadVideoById(trailer.key);
                        ytPlayer.mute(); 
                    } else {
                        createPlayer(trailer.key);
                    }
                }
            } catch(e) { console.error("Billboard Load Error:", e); }
        }

        function createPlayer(videoId) {
            ytPlayer = new YT.Player('ytPlayer', {
                height: '100%',
                width: '100%',
                videoId: videoId,
                playerVars: { 
                    'autoplay': 1, 'controls': 0, 'mute': 1, 'rel': 0, 'modestbranding': 1, 'loop': 0 
                },
                events: {
                    'onReady': (e) => e.target.playVideo(),
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.ENDED) {
                nextBillboard();
            }
        }

        function nextBillboard() {
            clearTimeout(billboardTimeout);
            let nextIndex = (billboardIndex + 1) % billboardQueue.length;
            loadBillboardItem(nextIndex);
        }

        billboardTimeout = setInterval(nextBillboard, 45000);


        // --- Init ---
        async function initAuth() {
            if (!auth) return;
            
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    console.log("User Authenticated:", user.uid);
                    listenToRecommendations();
                    listenToSeenList();
                } else {
                    console.log("Signing in anonymously...");
                    signInAnonymously(auth).catch(e => console.error("Auth Failed:", e));
                }
            });
        }
        initAuth();

        // --- Robust CSV Loader ---
        async function loadCSVData() {
            try {
                console.log("Loading CSVs...");
                const [moviesRes, showsRes] = await Promise.all([
                    fetch('data/movies_data.csv').catch(() => null),
                    fetch('data/shows_data.csv').catch(() => null)
                ]);

                const movies = await parseMovies(moviesRes);
                const shows = await parseShows(showsRes);

                allMovies = []; allShows = []; allAnime = [];

                const categorize = (item) => {
                    let isAnime = false;
                    if(item.country && (item.country.includes('Japan') || item.country.includes('JP'))) isAnime = true;
                    if(item.lang && (item.lang.includes('japanese') || item.lang==='ja')) isAnime = true;

                    if(isAnime) {
                        item.is_anime = true;
                        allAnime.push(item);
                    } else if (item.media_type === 'tv') {
                        allShows.push(item);
                    } else {
                        allMovies.push(item);
                    }
                    seenTitles.add(item.title.toLowerCase());
                };

                movies.forEach(categorize);
                shows.forEach(categorize);

                const missingPosters = [...allShows, ...allAnime].filter(i => !i.poster_path);
                posterQueue.push(...missingPosters);
                processPosterQueue();

                renderHomeRows();

            } catch (e) {
                console.error("CSV Parse Error:", e);
            }
        }

        // --- CSV Parsing Helpers ---
        
        async function parseMovies(res) {
            if (!res || !res.ok) return [];
            const text = await res.text();
            const lines = parseCSVLines(text);
            if(lines.length < 2) return [];
            
            const h = lines[0].map(s => s.toLowerCase().trim());
            const idx = {
                title: h.indexOf('title'),
                tmdb: h.indexOf('tmdb_id'),
                poster: h.indexOf('poster'),
                lang: h.indexOf('language'),
                country: h.indexOf('country'),
                genre: h.indexOf('genre'),
                year: h.indexOf('year')
            };

            return lines.slice(1).map(row => {
                if(!row[idx.title]) return null;
                return {
                    id: row[idx.tmdb] || `mov-${Math.random()}`,
                    tmdb_id: row[idx.tmdb],
                    title: row[idx.title],
                    name: row[idx.title],
                    poster_path: row[idx.poster],
                    media_type: 'movie',
                    lang: row[idx.lang],
                    country: row[idx.country],
                    genre_str: row[idx.genre],
                    release_date: row[idx.year]
                };
            }).filter(x => x);
        }

        async function parseShows(res) {
            if (!res || !res.ok) return [];
            const text = await res.text();
            const lines = parseCSVLines(text);
            if(lines.length < 2) return [];

            const h = lines[0].map(s => s.toLowerCase().trim());
            const idx = {
                title: h.indexOf('title'),
                country: h.indexOf('network_country'),
                genre: h.indexOf('genres')
            };

            return lines.slice(1).map(row => {
                if(!row[idx.title]) return null;
                return {
                    id: `show-${Math.random()}`,
                    title: row[idx.title],
                    name: row[idx.title],
                    poster_path: null,
                    media_type: 'tv',
                    country: row[idx.country],
                    genre_str: row[idx.genre]
                };
            }).filter(x => x);
        }

        function parseCSVLines(text) {
            const lines = [];
            let currentRow = [];
            let inQuote = false;
            let currentVal = '';
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                if (char === '"' && text[i+1] === '"') { currentVal += '"'; i++; }
                else if (char === '"') { inQuote = !inQuote; }
                else if (char === ',' && !inQuote) { currentRow.push(currentVal.trim()); currentVal = ''; }
                else if ((char === '\r' || char === '\n') && !inQuote) {
                    if (currentVal || currentRow.length > 0) currentRow.push(currentVal.trim());
                    if (currentRow.length > 0) lines.push(currentRow);
                    currentRow = []; currentVal = '';
                } 
                else { currentVal += char; }
            }
            if (currentVal || currentRow.length > 0) {
                currentRow.push(currentVal.trim());
                lines.push(currentRow);
            }
            return lines;
        }

        // --- Background Poster Fetcher ---
        async function processPosterQueue() {
            if (!API_KEY) return;
            if (isFetchingPoster || posterQueue.length === 0) return;
            isFetchingPoster = true;

            const item = posterQueue.shift();
            const cacheKey = `poster_${item.title}`;
            const cached = localStorage.getItem(cacheKey);
            
            if (cached) {
                updateItemPoster(item, cached);
                isFetchingPoster = false;
                processPosterQueue();
                return;
            }

            try {
                const res = await fetch(`${BASE_URL}/search/${item.media_type}?api_key=${API_KEY}&query=${encodeURIComponent(item.title)}`);
                const data = await res.json();
                
                if (data.results && data.results.length > 0) {
                    const hit = data.results[0];
                    if (hit.poster_path) {
                        localStorage.setItem(cacheKey, hit.poster_path);
                        updateItemPoster(item, hit.poster_path);
                        item.tmdb_id = hit.id;
                    }
                }
            } catch (e) { console.warn("Poster fetch failed", item.title); }

            setTimeout(() => {
                isFetchingPoster = false;
                processPosterQueue();
            }, 200); 
        }

        function updateItemPoster(item, path) {
            item.poster_path = path;
            const imgs = document.querySelectorAll(`img[data-title="${item.title}"]`);
            imgs.forEach(img => {
                img.src = IMG_URL + path;
                img.onload = () => {
                    img.classList.add('loaded');
                    if(img.nextElementSibling && img.nextElementSibling.classList.contains('placeholder-title')) {
                        img.nextElementSibling.style.display = 'none';
                    }
                };
            });
        }

        // --- Rendering ---
        function renderHomeRows() {
            const movTrack = document.getElementById('moviesTrack');
            const showTrack = document.getElementById('showsTrack');
            const aniTrack = document.getElementById('animeTrack');
            
            movTrack.innerHTML = ''; showTrack.innerHTML = ''; aniTrack.innerHTML = '';
            
            allMovies.forEach(m => createCard(m, movTrack, false));
            allShows.forEach(s => createCard(s, showTrack, false));
            allAnime.forEach(a => createCard(a, aniTrack, false));
        }

        function createCard(item, track, isRec) {
            const div = document.createElement('div');
            div.className = 'movie-box';
            
            let src = item.poster_path;
            if (src && !src.startsWith('http')) src = IMG_URL + src;
            
            div.innerHTML = `
                <img src="${src || ''}" class="${src ? 'loaded' : ''}" data-title="${item.title || item.name}">
                <div class="placeholder-title" ${src ? 'style="display:none"' : ''}>${item.title || item.name}</div>
                <div class="hover-details">${item.title || item.name}</div>
            `;
            div.onclick = () => openDetails(item, isRec);
            track.appendChild(div);
        }

        function addToCorrectRow(item) {
            let targetList, targetTrack;
            let isAnime = false;
            
            if(item.country && (item.country.includes('Japan') || item.country.includes('JP'))) isAnime = true;
            if(item.original_language === 'ja') isAnime = true; 

            if(isAnime) {
                targetList = allAnime;
                targetTrack = document.getElementById('animeTrack');
                item.is_anime = true;
            } else if (item.media_type === 'tv') {
                targetList = allShows;
                targetTrack = document.getElementById('showsTrack');
            } else {
                targetList = allMovies;
                targetTrack = document.getElementById('moviesTrack');
            }

            const exists = targetList.some(i => i.id == item.id || i.title == item.title);
            if (!exists) {
                targetList.push(item);
                createCard(item, targetTrack, false);
                seenTitles.add(item.title.toLowerCase()); 
            }
        }

        // --- Details ---
        window.openDetails = async (item, isRec) => {
            if(!API_KEY) return alert("TMDB API Key missing in config.js");
            currentOpenItem = item;
            
            let apiData = null;
            const searchId = item.tmdb_id || item.id; 
            const type = item.media_type || 'movie';

            if (searchId && !String(searchId).startsWith('csv-') && !String(searchId).startsWith('show-')) {
                try {
                    const res = await fetch(`${BASE_URL}/${type}/${searchId}?api_key=${API_KEY}&append_to_response=videos,credits,similar`);
                    if(res.ok) apiData = await res.json();
                } catch(e) {}
            }

            if (!apiData) {
                const q = encodeURIComponent(item.title || item.name);
                const endpoint = type === 'tv' ? 'tv' : 'movie';
                const search = await fetch(`${BASE_URL}/search/${endpoint}?api_key=${API_KEY}&query=${q}`);
                const sData = await search.json();
                if (sData.results && sData.results.length > 0) {
                    const hit = sData.results[0];
                    item.tmdb_id = hit.id; 
                    const finalRes = await fetch(`${BASE_URL}/${type}/${hit.id}?api_key=${API_KEY}&append_to_response=videos,credits,similar`);
                    apiData = await finalRes.json();
                }
            }

            const d = apiData || item;
            currentOpenItem.details = d;

            document.getElementById('mTitle').innerText = d.title || d.name;
            document.getElementById('mDesc').innerText = d.overview || "No description available.";
            document.getElementById('mYear').innerText = (d.release_date||d.first_air_date||item.release_date||'').substring(0,4);
            
            const cast = d.credits ? d.credits.cast.slice(0,3).map(c=>c.name).join(', ') : '-';
            document.getElementById('mCast').innerText = cast;
            
            const genres = d.genres ? d.genres.map(g=>g.name).join(', ') : (item.genre_str || '-');
            document.getElementById('mGenres').innerText = genres;

            const trailer = d.videos?.results?.find(v => v.site==='YouTube' && v.type==='Trailer');
            const frame = document.getElementById('modalFrame');
            const poster = document.getElementById('modalPoster');
            
            if(trailer) { 
                frame.src=`https://www.youtube.com/embed/${trailer.key}?autoplay=1&mute=0&controls=0`; 
                frame.classList.remove('hidden'); poster.classList.add('hidden'); 
            } else { 
                frame.classList.add('hidden'); poster.classList.remove('hidden'); 
                let p = d.backdrop_path ? (IMG_URL + d.backdrop_path) : item.poster_path;
                if(p && !p.startsWith('http')) p = IMG_URL + p;
                poster.src = p || ''; 
            }

            const mlt = document.getElementById('mltGrid'); mlt.innerHTML='';
            if(d.similar?.results) {
                d.similar.results.slice(0,6).forEach(s=>{
                    const div=document.createElement('div'); div.className='mlt-card';
                    div.innerHTML=`<img src="${IMG_URL}${s.backdrop_path}">`;
                    div.onclick=()=>openDetails(s,false); mlt.appendChild(div);
                });
            }

            document.getElementById('checkOffSection').classList.toggle('hidden', !isRec);
            if(isRec) document.getElementById('mRecommenderName').innerText = item.recommender || '-';

            const tabEp = document.getElementById('tabEpisodes');
            const sSel = document.getElementById('seasonSelect');
            if(d.seasons || type==='tv') {
                tabEp.classList.remove('hidden'); sSel.innerHTML='';
                if(d.seasons) {
                    d.seasons.forEach(s=>{ if(s.season_number>0){const o=document.createElement('option'); o.value=s.season_number; o.innerText=s.name; sSel.appendChild(o);} });
                }
            } else tabEp.classList.add('hidden');
            
            switchTab('MLT');
            document.getElementById('detailModal').style.display='flex';
        };

        // --- Listeners ---
        function listenToRecommendations() {
            if (!db) return;
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'recommendations'), (snap) => {
                const track = document.getElementById('recTrack'); track.innerHTML = '';
                currentRecIds.clear();
                const items = [];
                snap.forEach(d => {
                    const data = d.data();
                    items.push({ ...data, firestoreId: d.id });
                    currentRecIds.add(data.id);
                });
                document.getElementById('recRow').style.display = items.length > 0 ? 'block' : 'none';
                items.forEach(i => createCard(i, track, true));
            });
        }

        function listenToSeenList() {
            if (!db) return;
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'seen'), (snap) => {
                snap.forEach(d => {
                    const data = d.data();
                    const idStr = data.id.toString();
                    if (!seenList.has(idStr)) {
                        seenList.add(idStr);
                        if(data.title) seenTitles.add(data.title.toLowerCase());
                        addToCorrectRow(data);
                    }
                });
            });
        }

        // --- Other UI Logic ---
        let isMuted = true;
        window.toggleMute = () => {
            const iframe = document.getElementById('heroVideo');
            if(iframe) {
                isMuted = !isMuted;
                iframe.contentWindow.postMessage(JSON.stringify({ 'event': 'command', 'func': isMuted ? 'mute' : 'unMute', 'args': '' }), '*');
                document.getElementById('muteIcon').innerHTML = isMuted ? '<path d="M11 5L6 9H2V15H6L11 19V5z"></path><path d="M23 9L17 15"></path><path d="M17 9L23 15"></path>' : '<path d="M11 5L6 9H2V15H6L11 19V5z"></path><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>';
            }
        };

        window.showHome = () => { document.getElementById('homeView').classList.remove('hidden'); document.getElementById('gridView').classList.add('hidden'); };
        window.showGrid = (cat) => {
            document.getElementById('homeView').classList.add('hidden'); document.getElementById('gridView').classList.remove('hidden');
            let items=[], title="";
            if(cat==='movies'){items=allMovies; title="Movies";}
            else if(cat==='shows'){items=allShows; title="TV Shows";}
            else if(cat==='anime'){items=allAnime; title="Anime";}
            document.getElementById('gridPageTitle').innerText=title;
            document.getElementById('gridCount').innerText=`(${items.length})`;
            currentGridItems=items;
            const filter = document.getElementById('genreFilter');
            const genres = new Set();
            items.forEach(i=>{ if(i.genre_str) i.genre_str.split(',').forEach(g=>genres.add(g.trim())); });
            let opts=`<option value="all">All Genres</option>`;
            [...genres].sort().forEach(g=>opts+=`<option value="${g}">${g}</option>`);
            filter.innerHTML=opts;
            renderGrid(items);
        };

        window.renderGrid = (items) => {
            const grid=document.getElementById('mediaGrid'); grid.innerHTML='';
            items.forEach(item => {
                const div=document.createElement('div'); div.className='grid-card';
                let src=item.poster_path;
                if(src&&!src.startsWith('http')) src=IMG_URL+src;
                div.innerHTML=`<img src="${src||''}" class="${src?'loaded':''}" data-title="${item.title||item.name}"><div class="placeholder-title" ${src?'style="display:none"':''}>${item.title||item.name}</div><div class="hover-details">${item.title||item.name}</div>`;
                div.onclick=()=>openDetails(item,false);
                grid.appendChild(div);
            });
        };

        window.applyGridFilter = () => {
            const val=document.getElementById('genreFilter').value;
            if(val==='all') renderGrid(currentGridItems);
            else renderGrid(currentGridItems.filter(i=>i.genre_str && i.genre_str.includes(val)));
        };

        window.openSearch = () => { document.getElementById('searchOverlay').classList.add('active'); document.getElementById('fullSearchBar').focus(); };
        window.closeSearch = () => document.getElementById('searchOverlay').classList.remove('active');
        let searchTimeout;
        window.handleSearchKey = (e) => { clearTimeout(searchTimeout); searchTimeout = setTimeout(() => runSearch(e.target.value), 500); };
        async function runSearch(q) {
            if(!q) return;
            const res = await fetch(`${BASE_URL}/search/multi?api_key=${API_KEY}&query=${q}`);
            const data = await res.json();
            const grid = document.getElementById('searchGrid'); grid.innerHTML = '';
            data.results.forEach(i => {
                if(!i.backdrop_path) return;
                const div = document.createElement('div'); div.className = 'search-card';
                div.innerHTML = `<img src="${IMG_URL}${i.backdrop_path}"><div class="search-card-title">${i.title||i.name}</div>`;
                div.onclick = () => {
                    // Title-based + ID-based check
                    if(seenList.has(i.id.toString()) || seenTitles.has((i.title||i.name).toLowerCase())) {
                        openDetails(i, false);
                    } else if (currentRecIds.has(i.id)) {
                        alert("Already recommended!");
                    } else { 
                        pendingRecommendation = i; document.getElementById('recDialog').style.display = 'flex'; 
                    }
                };
                grid.appendChild(div);
            });
        }
        window.closeRecDialog = () => document.getElementById('recDialog').style.display = 'none';
        window.confirmRecommendation = async () => {
            const name = document.getElementById('recNameInput').value;
            if (!name) return alert("Enter your name");
            
            if (db) {
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'recommendations'), { ...pendingRecommendation, recommender: name });
                    closeRecDialog(); window.closeSearch(); alert("Recommended!");
                } catch(e) { console.error("Write Failed:", e); alert("Error saving to DB."); }
            }
        };

        window.switchTab = (t) => {
            document.getElementById('mltGrid').classList.toggle('hidden', t!=='MLT');
            document.getElementById('episodesGrid').classList.toggle('hidden', t!=='EPISODES');
            document.getElementById('tabMLT').classList.toggle('active', t==='MLT');
            document.getElementById('tabEpisodes').classList.toggle('active', t==='EPISODES');
            document.getElementById('seasonSelect').classList.toggle('hidden', t!=='EPISODES');
            if(t==='EPISODES') fetchSeason(document.getElementById('seasonSelect').value||1);
        };

        window.fetchSeason = async (n) => {
            if(!currentOpenItem || !currentOpenItem.details) return;
            const id = currentOpenItem.details.id;
            const res = await fetch(`${BASE_URL}/tv/${id}/season/${n}?api_key=${API_KEY}`);
            const d = await res.json();
            const g = document.getElementById('episodesGrid'); g.innerHTML='';
            if(d.episodes) d.episodes.forEach(e=>{
                const div=document.createElement('div'); div.className='episode-card';
                div.innerHTML=`<img class="episode-img" src="${IMG_URL}${e.still_path}" onerror="this.src='https://via.placeholder.com/300x170?text=No+Image'"><div class="episode-info"><div class="episode-title"><span>${e.episode_number}. ${e.name}</span></div><div class="episode-desc">${e.overview}</div></div>`;
                g.appendChild(div);
            });
        };

        window.closeModal = () => { document.getElementById('detailModal').style.display='none'; document.getElementById('modalFrame').src=''; };
        window.checkOffItem = () => { document.getElementById('passwordDialog').style.display='flex'; document.getElementById('adminPwdInput').value=''; };
        window.closePasswordDialog = () => document.getElementById('passwordDialog').style.display='none';
        
        window.submitAdminPassword = async () => {
            // Using password from config
            const correctPwd = localConfig.ADMIN_PWD || 'admin';
            if(document.getElementById('adminPwdInput').value === correctPwd) {
                closePasswordDialog();
                if(!currentOpenItem.firestoreId) {
                    console.error("Item has no Firestore ID, can't delete.");
                    return;
                }
                try {
                    const itemToSave = { ...currentOpenItem, details: null };
                    delete itemToSave.details; 
                    await addDoc(collection(db,'artifacts',appId,'public','data','seen'), itemToSave);
                    await deleteDoc(doc(db,'artifacts',appId,'public','data','recommendations',currentOpenItem.firestoreId));
                    closeModal(); alert('Added to library');
                } catch(e) { console.error("Admin Action Failed:", e); alert("DB Error"); }
            } else alert('Wrong password');
        };

        window.startApp = () => { document.getElementById('profileLayer').classList.add('hidden'); document.getElementById('app').classList.remove('hidden'); loadCSVData(); };
        window.scrollRow = (id, d) => document.getElementById(id).scrollBy({left:d*window.innerWidth*0.8, behavior:'smooth'});
        window.addEventListener('scroll', ()=>{ document.getElementById('mainHeader').classList.toggle('scrolled', window.scrollY>20); });

    </script>
</body>
</html>